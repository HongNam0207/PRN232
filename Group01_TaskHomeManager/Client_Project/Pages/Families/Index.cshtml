@page
@model dynamic
@{
    ViewData["Title"] = "Danh sách công việc";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(180deg, #f8faff 0%, #eef2fb 100%);
        min-height: 100vh;
    }

    .header-bar {
        background: linear-gradient(90deg, #4c6ef5, #5f8efb);
        border-radius: 12px;
        color: white;
        padding: 1.2rem 1.6rem;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

        .header-bar h3 {
            margin: 0;
            font-weight: 600;
        }

    .task-card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.06);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background-color: #fff;
        transition: transform 0.15s ease;
    }

        .task-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
        }

    .task-title {
        font-weight: 600;
    }

        .task-title.completed {
            text-decoration: line-through;
            color: #28a745;
        }

    .comment-box {
        border-top: 1px solid #e9ecef;
        padding-top: 1rem;
        margin-top: 1rem;
    }

    .comment {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        margin-bottom: 0.5rem;
    }

        .comment small {
            font-size: 0.8rem;
            color: #6c757d;
        }

    .btn-outline-primary, .btn-outline-success {
        font-weight: 500;
    }

    .empty-text {
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
</style>

<div class="container">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <h3>🧾 Danh sách công việc</h3>
        <div>
            <a href="/Families/Create?familyId=@Request.Query["familyId"]" class="btn btn-light btn-sm shadow-sm me-2">
                ➕ Thêm công việc
            </a>
            <button class="btn btn-light btn-sm shadow-sm" onclick="window.history.back()">⬅ Quay lại</button>
        </div>
    </div>

    <div id="taskList" class="mb-4">
        <p class="text-center text-muted">⏳ Đang tải dữ liệu...</p>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const familyId = new URLSearchParams(window.location.search).get("familyId");
    const apiTasks = "https://localhost:7145/api/Tasks";
    const apiComments = "https://localhost:7145/api/Comments";

    async function loadTasks() {
        const listDiv = document.getElementById("taskList");
        listDiv.innerHTML = `<p class='text-center text-muted'>⏳ Đang tải dữ liệu...</p>`;

        try {
            const res = await fetch(`${apiTasks}?familyId=${familyId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Không thể tải công việc");
            const data = await res.json();

            if (!data || data.length === 0) {
                listDiv.innerHTML = "<p class='empty-text'>Chưa có công việc nào.</p>";
                return;
            }

            listDiv.innerHTML = data.map(t => `
                <div class="task-card">
                    <div class="d-flex justify-content-between align-items-start flex-wrap">
                        <div class="me-auto">
                            <h6 class="task-title ${t.status === 'Completed' ? 'completed' : ''}">
                                ${t.title}
                            </h6>
                            <p class="text-muted mb-1">${t.description || "Không có mô tả"}</p>
                            <p class="mb-1">
                                📅 <b>Hạn:</b> ${t.dueDate ? new Date(t.dueDate).toLocaleDateString('vi-VN') : "Không có"}
                            </p>
                            <p class="mb-0">
                                👤 <b>Người nhận:</b>
                                ${t.assignedUserNames && t.assignedUserNames.length > 0
                                    ? t.assignedUserNames.join(", ")
                                    : "<span class='text-secondary'>Chưa giao</span>"}
                            </p>
                        </div>
                        <div class="d-flex flex-wrap mt-2">
                            <a href="/Families/Edit?id=${t.taskId}&familyId=${familyId}"
                               class="btn btn-outline-primary btn-sm me-2">✏️ Sửa</a>
                            <a href="/Families/Manage?id=${t.taskId}&familyId=${familyId}"
                               class="btn btn-outline-success btn-sm">⚙️ Quản lý</a>
                        </div>
                    </div>

                    <!-- 💬 Khu vực bình luận -->
                    <div class="comment-box">
                        <div id="comments-${t.taskId}" class="text-muted small mb-2">💬 Đang tải bình luận...</div>
                        <div class="input-group input-group-sm">
                            <input type="text" id="commentInput-${t.taskId}" class="form-control"
                                   placeholder="Viết bình luận..." />
                            <button class="btn btn-primary" onclick="addComment(${t.taskId})">Gửi</button>
                        </div>
                    </div>
                </div>
            `).join("");

            data.forEach(t => loadComments(t.taskId));

        } catch (err) {
            console.error(err);
            listDiv.innerHTML = "<p class='text-danger text-center'>❌ Không thể tải dữ liệu.</p>";
        }
    }

    // 🗨️ Tải bình luận cho từng công việc
    async function loadComments(taskId) {
        const el = document.getElementById(`comments-${taskId}`);
        try {
            const res = await fetch(`${apiComments}/task/${taskId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error();
            const data = await res.json();

            if (data.length === 0) {
                el.innerHTML = "<span class='text-muted small'>Chưa có bình luận nào.</span>";
            } else {
                el.innerHTML = data.map(c => `
                    <div class="comment">
                        <b>${c.fullName}</b>: ${c.content}
                        <div><small>${new Date(c.createdAt).toLocaleString('vi-VN')}</small></div>
                    </div>
                `).join("");
            }
        } catch {
            el.innerHTML = "<span class='text-danger small'>⚠️ Lỗi tải bình luận.</span>";
        }
    }

    // 💬 Thêm bình luận
    async function addComment(taskId) {
        const input = document.getElementById(`commentInput-${taskId}`);
        const content = input.value.trim();
        if (!content) return;

        try {
            const res = await fetch(apiComments, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ taskId, content })
            });

            if (res.ok) {
                input.value = "";
                loadComments(taskId);
            } else {
                Swal.fire({
                    icon: "error",
                    title: "Không thể gửi bình luận!",
                    confirmButtonColor: "#d33"
                });
            }
        } catch (err) {
            Swal.fire({
                icon: "error",
                title: "Lỗi kết nối!",
                text: err.message,
                confirmButtonColor: "#d33"
            });
        }
    }

    loadTasks();
</script>
