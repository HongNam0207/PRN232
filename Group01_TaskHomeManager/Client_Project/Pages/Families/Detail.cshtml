@page
@model dynamic
@{
    ViewData["Title"] = "Chi tiết gia đình";
}

<div class="container mt-4">
    <h3 id="familyName"></h3>
    <p id="familyAddress" class="text-muted"></p>

    <hr>

    <h5>Thành viên</h5>
    <ul id="memberList" class="list-group mb-4"></ul>

    <a href="/Members/Add" class="btn btn-outline-primary mb-5">Thêm thành viên</a>

    <h5>Dự án trong gia đình</h5>
    <div id="projectList" class="row g-3"></div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const familyId = urlParams.get("familyId");
    const token = localStorage.getItem("token");

    async function loadFamily() {
        const res = await fetch("https://localhost:7145/api/FamilyMembers/myfamilyinfo", {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();

        let f = data.find(x => x.familyId == familyId);
        document.getElementById("familyName").innerText = f.familyName;
        document.getElementById("familyAddress").innerText = f.address ?? "Chưa cập nhật";
    }

    async function loadMembers() {
        const res = await fetch("https://localhost:7145/api/FamilyMembers/myfamily", {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();

        const list = document.getElementById("memberList");
        data.forEach(m => {
            list.innerHTML += `<li class="list-group-item">${m.fullName} (${m.relationship})</li>`;
        });
    }

    async function loadProjects() {
        const res = await fetch("https://localhost:7145/api/Projects", {
            headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();

        const list = document.getElementById("projectList");
        data.forEach(p => {
            list.innerHTML += `
                <div class="col-md-4">
                    <div class="card p-3 shadow-sm">
                        <h5>${p.projectName}</h5>
                        <p class="text-muted small">${p.description ?? ""}</p>
                        <a href="/Projects/Detail?projectId=${p.projectId}" class="btn btn-outline-primary w-100">Xem</a>
                    </div>
                </div>`;
        });
    }

    loadFamily();
    loadMembers();
    loadProjects();
</script>
