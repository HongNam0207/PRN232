@page
@model dynamic
@{
    ViewData["Title"] = "Quản lý công việc";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(180deg, #f8faff 0%, #eef2fb 100%);
        min-height: 100vh;
    }

    .header-bar {
        background: linear-gradient(90deg, #4c6ef5, #5f8efb);
        border-radius: 12px;
        color: white;
        padding: 1.2rem 1.6rem;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

        .header-bar h3 {
            margin: 0;
            font-weight: 600;
        }

    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        background: #fff;
    }

    .status-badge {
        font-size: 0.9rem;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        color: white;
        font-weight: 500;
    }

    .status-Completed {
        background-color: #28a745;
    }

    .status-Pending {
        background-color: #ffc107;
        color: #212529;
    }

    .btn {
        font-weight: 500;
    }

    .btn-success, .btn-warning, .btn-danger {
        transition: 0.2s;
    }

        .btn-success:hover {
            background-color: #198754 !important;
        }

        .btn-warning:hover {
            background-color: #e0a800 !important;
        }

        .btn-danger:hover {
            background-color: #c82333 !important;
        }
</style>

<div class="container">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <h3>⚙️ Quản lý công việc</h3>
        <a href="javascript:history.back()" class="btn btn-light btn-sm shadow-sm">⬅ Quay lại</a>
    </div>

    <div id="taskInfo" class="card p-4 mb-3 text-center">
        <p class="text-muted">⏳ Đang tải dữ liệu...</p>
    </div>

    <div class="d-flex gap-3 justify-content-center">
        <button class="btn btn-success px-4" id="btnDone">✅ Hoàn thành</button>
        <button class="btn btn-warning px-4" id="btnReopen">↩ Mở lại</button>
        <button class="btn btn-danger px-4" id="btnDelete">🗑️ Xóa</button>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const familyId = new URLSearchParams(window.location.search).get("familyId");
    const taskId = new URLSearchParams(window.location.search).get("id");
    const apiTasks = "https://localhost:7145/api/Tasks";

    // ==================== 🔹 Load thông tin công việc ====================
    async function loadTask() {
        const taskInfo = document.getElementById("taskInfo");
        taskInfo.innerHTML = `<p class='text-muted'>⏳ Đang tải dữ liệu...</p>`;

        try {
            const res = await fetch(`${apiTasks}?familyId=${familyId}`, {
                headers: { "Authorization": `Bearer ${token}` }
            });
            if (!res.ok) throw new Error("Không tải được danh sách công việc.");

            const tasks = await res.json();
            const t = tasks.find(x => x.taskId == taskId);

            if (!t) {
                taskInfo.innerHTML = `<p class='text-danger'>❌ Không tìm thấy công việc này.</p>`;
                return;
            }

            taskInfo.innerHTML = `
                <h5 class="fw-bold mb-2">${t.title}</h5>
                <p class="text-muted">${t.description || 'Không có mô tả.'}</p>
                <p class="mb-1">📅 <b>Hạn:</b> ${t.dueDate ? new Date(t.dueDate).toLocaleDateString('vi-VN') : 'Không có'}</p>
                <p class="mb-0">📊 <b>Trạng thái:</b>
                    <span class="status-badge status-${t.status}">${t.status === 'Completed' ? 'Hoàn thành' : 'Đang chờ'}</span>
                </p>
            `;
        } catch (err) {
            taskInfo.innerHTML = `<p class='text-danger'>⚠️ Lỗi: ${err.message}</p>`;
        }
    }

    loadTask();

    // ==================== 🔹 Cập nhật trạng thái ====================
    async function updateStatus(status) {
        Swal.fire({
            title: "Xác nhận thay đổi trạng thái?",
            text: `Công việc này sẽ được đánh dấu là "${status === 'Completed' ? 'Hoàn thành' : 'Đang chờ'}".`,
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Xác nhận",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#4c6ef5"
        }).then(async (result) => {
            if (!result.isConfirmed) return;

            try {
                const res = await fetch(`${apiTasks}/${taskId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });

                if (!res.ok) throw new Error("Không thể cập nhật trạng thái.");

                Swal.fire({
                    icon: "success",
                    title: "Cập nhật thành công!",
                    timer: 1500,
                    showConfirmButton: false
                });

                loadTask();
            } catch (err) {
                Swal.fire({
                    icon: "error",
                    title: "❌ Lỗi!",
                    text: err.message
                });
            }
        });
    }

    document.getElementById("btnDone").onclick = () => updateStatus("Completed");
    document.getElementById("btnReopen").onclick = () => updateStatus("Pending");

    // ==================== 🔹 Xóa công việc ====================
    document.getElementById("btnDelete").onclick = async () => {
        Swal.fire({
            title: "Xóa công việc?",
            text: "Thao tác này không thể hoàn tác!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "🗑️ Xóa",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#d33"
        }).then(async (result) => {
            if (!result.isConfirmed) return;
            try {
                const res = await fetch(`${apiTasks}/${taskId}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (!res.ok) throw new Error("Không thể xóa công việc.");

                Swal.fire({
                    icon: "success",
                    title: "🗑️ Đã xóa thành công!",
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = `/Families/Index?familyId=${familyId}`;
                });
            } catch (err) {
                Swal.fire({
                    icon: "error",
                    title: "❌ Lỗi khi xóa!",
                    text: err.message
                });
            }
        });
    };
</script>
