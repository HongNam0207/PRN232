@page
@model dynamic
@{
    ViewData["Title"] = "Chi tiết công việc";
}

<div class="container mt-4">
    <h3 id="title"></h3>
    <p id="desc"></p>
    <p><strong>Trạng thái:</strong> <span id="status"></span></p>

    <hr>
    <h5>Bình luận</h5>
    <div id="comments" class="mb-3"></div>

    <div class="input-group">
        <input id="content" class="form-control" placeholder="Nhập bình luận...">
        <button class="btn btn-primary" id="send">Gửi</button>
    </div>
</div>

<script>
    const taskId = new URLSearchParams(location.search).get("taskId");
    const token = localStorage.getItem("token");

    async function loadTask(){
     const r=await fetch(`/api/Tasks/${taskId}`,{headers:{Authorization:`Bearer ${token}`}});
     const x=await r.json();
     title.innerText=x.title; desc.innerText=x.description; status.innerText=x.status;
    }
    async function loadComments(){
     const r=await fetch(`/api/Comments/task/${taskId}`,{headers:{Authorization:`Bearer ${token}`}});
     const x=await r.json();
     comments.innerHTML=x.map(c=>`
      <div class="p-2 mb-2 border rounded">
       <b>${c.fullName}</b><br>${c.content}<br><small>${c.createdAt}</small>
      </div>`).join("");
    }
    send.onclick=async()=>{
     await fetch(`/api/Comments`,{
       method:"POST",
       headers:{Authorization:`Bearer ${token}`,"Content-Type":"application/json"},
       body:JSON.stringify({taskId,content:content.value})
     });
     content.value=""; loadComments();
    }
    loadTask(); loadComments();
</script>
