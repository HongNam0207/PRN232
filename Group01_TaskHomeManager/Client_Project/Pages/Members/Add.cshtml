@page
@model dynamic
@{
    ViewData["Title"] = "Thêm thành viên";
}

<div class="container mt-4" style="max-width: 500px;">
    <h3 class="mb-3">Thêm thành viên vào gia đình</h3>

    <form id="addMemberForm">

        <label class="form-label">Email người dùng</label>
        <input id="email" class="form-control mb-3" placeholder="Nhập email..." required>

        <label class="form-label">Quan hệ</label>
        <select id="relationship" class="form-select mb-3">
            <option value="Cha">Cha</option>
            <option value="Mẹ">Mẹ</option>
            <option value="Con">Con</option>
            <option value="Ông">Ông</option>
            <option value="Bà">Bà</option>
            <option value="Thành viên">Thành viên</option>
        </select>

        <button class="btn btn-primary w-100">Thêm</button>
    </form>

    <p id="message" class="mt-3 text-center"></p>
</div>

<script>
    document.getElementById("addMemberForm").addEventListener("submit", async e => {
        e.preventDefault();
        const token = localStorage.getItem("token");

        // 1) Tìm UserId theo email
        const email = document.getElementById("email").value;
        const userRes = await fetch(`https://localhost:7145/api/Search/user-by-email?email=${email}`);
        const user = await userRes.json();

        if (!user || !user.userId) {
            document.getElementById("message").innerText = "Không tìm thấy người dùng.";
            return;
        }

        // 2) Gọi API thêm thành viên
        const res = await fetch("https://localhost:7145/api/FamilyMembers/add", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
            body: JSON.stringify({
                userId: user.userId,
                relationship: document.getElementById("relationship").value
            })
        });

        const msg = document.getElementById("message");
        if (res.ok) {
            msg.style.color = "green";
            msg.innerText = "Thêm thành viên thành công!";
            setTimeout(() => window.location.href = "/Members/Index", 1000);
        } else {
            msg.style.color = "red";
            msg.innerText = "Không thể thêm thành viên!";
        }
    });
</script>
