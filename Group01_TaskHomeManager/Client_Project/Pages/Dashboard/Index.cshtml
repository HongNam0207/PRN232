@page
@model dynamic
@{
    ViewData["Title"] = "Trang chủ gia đình";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background: linear-gradient(180deg, #f8faff 0%, #eef2fb 100%);
        min-height: 100vh;
    }

    .header-bar {
        background: linear-gradient(90deg, #4c6ef5, #5f8efb);
        border-radius: 12px;
        color: white;
        padding: 1.2rem 1.6rem;
        margin-top: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

        .header-bar h3 {
            margin: 0;
            font-weight: 600;
        }

    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        background: #fff;
    }

    .family-item {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        transition: 0.25s ease;
    }

        .family-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

    .btn-sm {
        font-weight: 500;
    }

    .empty-text {
        color: #6c757d;
        font-size: 0.95rem;
        text-align: center;
        margin-top: 1rem;
    }
</style>

<div class="container">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <h3>🏠 Xin chào, <span id="username"></span>!</h3>
        <button class="btn btn-light btn-sm shadow-sm" id="logoutBtn">🚪 Đăng xuất</button>
    </div>

    <div class="card p-4 mx-auto" style="max-width: 800px;">
        <div class="card-body text-center">
            <h5 class="card-title mb-3">👨‍👩‍👧‍👦 Gia đình của bạn</h5>
            <div id="familyInfo" class="mt-3 small text-muted">⏳ Đang tải thông tin...</div>
            <div class="d-flex justify-content-center gap-2 mt-4">
                <a href="/Dashboard/Create" class="btn btn-primary btn-sm">➕ Tạo gia đình mới</a>
                <a href="/Dashboard/Join" class="btn btn-success btn-sm">🔑 Tham gia bằng mã</a>
            </div>
        </div>
    </div>
</div>

<script>
    const token = localStorage.getItem("token");
    const user = JSON.parse(localStorage.getItem("user") || "{}");
    const apiUrl = "https://localhost:7145/api/Families";

    if (!token) window.location.href = "/Auth/Login";
    document.getElementById("username").textContent = user.fullName || "Thành viên";

    document.getElementById("logoutBtn").addEventListener("click", () => {
        Swal.fire({
            title: "Xác nhận đăng xuất?",
            text: "Bạn có chắc muốn đăng xuất khỏi hệ thống?",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Đăng xuất",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#dc3545"
        }).then(result => {
            if (result.isConfirmed) {
                localStorage.clear();
                window.location.href = "/Auth/Login";
            }
        });
    });

    const infoDiv = document.getElementById("familyInfo");

    // 🔹 Load danh sách gia đình
    async function loadFamilies() {
        infoDiv.innerHTML = "⏳ Đang tải...";
        try {
            const res = await fetch(`${apiUrl}/myfamilies`, {
                headers: { "Authorization": `Bearer ${token}` }
            });

            if (!res.ok) throw new Error("Không tải được dữ liệu.");

            const data = await res.json();
            if (!data || data.length === 0) {
                infoDiv.innerHTML = `<p class="empty-text">Chưa có gia đình nào được tạo hoặc tham gia.</p>`;
                return;
            }

            infoDiv.innerHTML = data.map(f => `
                <div class="family-item mb-3 text-start">
                    <h5 class="mb-1 text-primary">${f.familyName}</h5>
                    <p class="mb-0">🏷️ <b>Mã:</b> ${f.familyCode || "Chưa có"}</p>
                    <p class="mb-0">📍 <b>Địa chỉ:</b> ${f.address || "Chưa có địa chỉ"}</p>
                    <small class="text-muted">👤 Vai trò: ${f.relationship || "Thành viên"}</small>
                    <div class="mt-3">
                        <button class="btn btn-info btn-sm me-1" onclick="viewFamily(${f.familyId})">👁️ Xem chi tiết</button>
                        <a href="/Dashboard/Edit?id=${f.familyId}" class="btn btn-warning btn-sm me-1 text-white">✏️ Sửa</a>
                        <button class="btn btn-danger btn-sm" onclick="deleteFamily(${f.familyId}, '${f.familyName}')">🗑️ Xóa</button>
                    </div>
                </div>
            `).join("");
        } catch (err) {
            infoDiv.innerHTML = `<p class="text-danger mt-2">❌ ${err.message}</p>`;
        }
    }

    loadFamilies();

    function viewFamily(id) {
        window.location.href = `/Families/Index?familyId=${id}`;
    }

    // 🔹 Xóa gia đình (hiển thị SweetAlert xác nhận)
    async function deleteFamily(id, name) {
        Swal.fire({
            title: `Xóa gia đình "${name}"?`,
            text: "Hành động này không thể hoàn tác!",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "🗑️ Xóa",
            cancelButtonText: "Hủy",
            confirmButtonColor: "#dc3545"
        }).then(async (result) => {
            if (!result.isConfirmed) return;

            try {
                const res = await fetch(`${apiUrl}/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (res.ok) {
                    Swal.fire({
                        icon: "success",
                        title: "Đã xóa thành công!",
                        timer: 1500,
                        showConfirmButton: false
                    });
                    loadFamilies();
                } else {
                    const err = await res.json().catch(() => ({}));
                    Swal.fire({
                        icon: "error",
                        title: "Không thể xóa!",
                        text: err.message || "Vui lòng thử lại.",
                        confirmButtonColor: "#d33"
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: "error",
                    title: "Lỗi kết nối!",
                    text: "Không thể kết nối tới máy chủ.",
                    confirmButtonColor: "#d33"
                });
            }
        });
    }
</script>
